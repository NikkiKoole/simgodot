{
  "project": "SimGodot",
  "branchName": "ralph/ground-item-pickup",
  "description": "Enable NPCs to discover and pick up items from anywhere - containers, station output slots, or on the ground. Currently NPCs can only find items in containers, but items spawned by recipes end up at stations or on the ground.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add Level.get_ground_items_by_tag() query method",
      "description": "As a developer, I want a way to query all ground items by tag so that NPCs and JobBoard can discover items not in containers.",
      "acceptanceCriteria": [
        "Level has get_ground_items_by_tag(tag: String) -> Array[ItemEntity] method",
        "Method returns only items with location == ItemLocation.ON_GROUND",
        "Method returns only unreserved items (item.is_reserved() == false)",
        "Method filters by item_tag matching the parameter",
        "Level tracks all spawned items in an array (already exists as all_items)",
        "Items spawned via _spawn_outputs are tracked in Level.all_items"
      ],
      "testCriteria": [
        "test_get_ground_items_empty: Returns empty array when no ground items exist",
        "test_get_ground_items_finds_matching: Returns items matching tag on ground",
        "test_get_ground_items_excludes_containers: Does not return items in containers",
        "test_get_ground_items_excludes_reserved: Does not return reserved items",
        "test_get_ground_items_excludes_held: Does not return items IN_HAND",
        "test_get_ground_items_excludes_slots: Does not return items IN_SLOT"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Level already has all_items array. Need to ensure items spawned by JobBoard._spawn_outputs are added to Level.all_items. May need Level reference passed to _spawn_outputs."
    },
    {
      "id": "US-002",
      "title": "Add Station.get_available_output_items_by_tag() method",
      "description": "As a developer, I want to query station output slots for available items so NPCs can pick up finished products.",
      "acceptanceCriteria": [
        "Station has get_available_output_items_by_tag(tag: String) -> Array[ItemEntity] method",
        "Method returns only items in output slots matching the tag",
        "Method returns only unreserved items",
        "Method works with existing output_slots array"
      ],
      "testCriteria": [
        "test_get_output_items_empty: Returns empty when no output items",
        "test_get_output_items_finds_matching: Returns items matching tag in output slots",
        "test_get_output_items_excludes_input_slots: Does not return items from input slots",
        "test_get_output_items_excludes_reserved: Does not return reserved items",
        "test_get_output_items_multiple_stations: Works correctly across multiple stations"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Station already has output_slots array. This is a simple filtered query."
    },
    {
      "id": "US-003",
      "title": "Extend JobBoard.can_start_job to check ground and station items",
      "description": "As a developer, I want can_start_job to find items anywhere (containers, ground, station outputs) so jobs using ground items are valid.",
      "acceptanceCriteria": [
        "can_start_job checks containers (existing behavior)",
        "can_start_job checks station output slots for matching items",
        "can_start_job checks ground items via Level reference",
        "can_start_job requires level parameter (or gets it via get_tree())",
        "Missing items reason distinguishes source types when helpful",
        "Total quantity_found sums all sources"
      ],
      "testCriteria": [
        "test_can_start_finds_container_items: Existing behavior unchanged",
        "test_can_start_finds_ground_items: Returns can_start=true when item on ground",
        "test_can_start_finds_station_output: Returns can_start=true when item in station output",
        "test_can_start_combines_sources: Finds items across multiple source types",
        "test_can_start_excludes_reserved: Does not count reserved items from any source",
        "test_can_start_partial_sources: Handles case where some items in container, some on ground"
      ],
      "priority": 3,
      "passes": true,
      "notes": "This is the core change. JobBoard needs Level reference - could pass as parameter or use get_tree().current_scene."
    },
    {
      "id": "US-004",
      "title": "Extend JobBoard._reserve_items_for_job to reserve from all sources",
      "description": "As a developer, I want item reservation to work for ground and station items so two NPCs don't path to the same item.",
      "acceptanceCriteria": [
        "_reserve_items_for_job reserves items from containers (existing)",
        "_reserve_items_for_job reserves items from station output slots",
        "_reserve_items_for_job reserves items from ground",
        "Items are reserved in order: containers first, then stations, then ground (nearest first)",
        "Reserved items are added to job.gathered_items as before"
      ],
      "testCriteria": [
        "test_reserve_from_container: Existing behavior unchanged",
        "test_reserve_from_ground: Ground items get reserved_by set to agent",
        "test_reserve_from_station_output: Station output items get reserved",
        "test_reserve_prefers_container: When item in container and ground, reserves container first",
        "test_reserve_multiple_sources: Can reserve from mixed sources for same job",
        "test_reserve_prevents_double_claim: Second NPC cannot reserve already-reserved ground item"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Reservation already works on ItemEntity - just need to find items from more sources."
    },
    {
      "id": "US-005",
      "title": "Add NPC._find_item_source() to locate items anywhere",
      "description": "As a developer, I want NPCs to find items from any source so they can haul from ground or stations.",
      "acceptanceCriteria": [
        "NPC has _find_item_source(tag: String) method",
        "Method returns Dictionary with 'type' and 'source' keys",
        "type can be 'container', 'ground', 'station_output', or 'none'",
        "source is the ItemContainer, ItemEntity, or Station respectively",
        "Method checks containers first, then stations, then ground",
        "Method respects reservations (finds unreserved or reserved-by-self)"
      ],
      "testCriteria": [
        "test_find_source_container: Returns container when item in container",
        "test_find_source_ground: Returns ground item when only on ground",
        "test_find_source_station: Returns station when item in output slot",
        "test_find_source_prefers_container: Returns container over ground when both exist",
        "test_find_source_reserved_by_self: Returns item reserved by this NPC",
        "test_find_source_excludes_others_reserved: Does not return item reserved by other NPC",
        "test_find_source_none: Returns type='none' when item not found anywhere"
      ],
      "priority": 5,
      "passes": true,
      "notes": "This replaces/extends _find_container_with_item. May want to keep both for backward compatibility."
    },
    {
      "id": "US-006",
      "title": "Extend NPC hauling to pick up ground items",
      "description": "As a developer, I want NPCs to pathfind to and pick up ground items so the production-consumption loop works.",
      "acceptanceCriteria": [
        "NPC can pathfind to a ground item's global_position",
        "NPC picks up ground item when arriving (removes from scene, adds to held_items)",
        "Ground item location changes from ON_GROUND to IN_HAND",
        "NPC hauling state machine handles ground item source type",
        "If ground item disappears before arrival, NPC re-searches for alternatives"
      ],
      "testCriteria": [
        "test_npc_pathfinds_to_ground_item: NPC moves toward ground item position",
        "test_npc_picks_up_ground_item: Item transfers to NPC.held_items on arrival",
        "test_ground_item_location_changes: Item location becomes IN_HAND after pickup",
        "test_ground_item_removed_from_parent: Item reparented from Level to NPC",
        "test_npc_handles_missing_item: NPC re-searches if item gone before arrival",
        "test_npc_continues_after_ground_pickup: NPC proceeds to next hauling step after pickup"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Key behavior change. NPC needs target_ground_item state similar to target_container."
    },
    {
      "id": "US-007",
      "title": "Extend NPC hauling to pick up from station output slots",
      "description": "As a developer, I want NPCs to pick up items from station output slots so finished products can be used.",
      "acceptanceCriteria": [
        "NPC can pathfind to a station with items in output slots",
        "NPC picks up item from station output slot when arriving",
        "Station.remove_output_item() is called to get the item",
        "Item location changes from IN_SLOT to IN_HAND",
        "NPC hauling state machine handles station_output source type"
      ],
      "testCriteria": [
        "test_npc_pathfinds_to_station_output: NPC moves toward station with output items",
        "test_npc_picks_up_station_output: Item transfers from station to NPC.held_items",
        "test_station_output_removed: Station no longer has item in output slot after pickup",
        "test_station_output_location_changes: Item location becomes IN_HAND",
        "test_npc_continues_after_station_pickup: NPC proceeds to next step after pickup"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Similar to US-006 but for station output slots. Stations already have remove_output_item()."
    },
    {
      "id": "US-008",
      "title": "Register spawned output items with Level.all_items",
      "description": "As a developer, I want items spawned by JobBoard._spawn_outputs to be tracked by Level so they can be discovered.",
      "acceptanceCriteria": [
        "_spawn_outputs adds new items to Level.all_items array",
        "_spawn_outputs gets Level reference via station.get_tree().current_scene or passed parameter",
        "Items spawned on ground are discoverable via Level.get_ground_items_by_tag()",
        "Items spawned in station output slots don't need Level registration (found via Station)"
      ],
      "testCriteria": [
        "test_spawn_outputs_registers_ground_items: Ground-spawned items in Level.all_items",
        "test_spawn_outputs_ground_discoverable: Level.get_ground_items_by_tag finds spawned items",
        "test_spawn_outputs_station_not_double_registered: Items in slots not duplicated in Level.all_items"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Without this, ground items spawned by recipes won't be found. Station slot items are found via Station query."
    },
    {
      "id": "US-009",
      "title": "Update existing tests to use new item discovery",
      "description": "As a developer, I want existing tests to work with the new item discovery system and verify backward compatibility.",
      "acceptanceCriteria": [
        "All existing tests in test_jobboard.gd still pass",
        "All existing tests in test_agent_hauling.gd still pass",
        "Tests that use can_start_job updated if signature changed",
        "Tests verify containers still work as primary item source"
      ],
      "testCriteria": [
        "test_existing_container_workflow: Full job with container items still works",
        "test_backward_compatible_can_start: can_start_job with only containers works",
        "test_backward_compatible_hauling: NPC hauling from containers unchanged"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Ensure no regression. If can_start_job signature changes, update call sites."
    },
    {
      "id": "US-010",
      "title": "E2E test: Full cook-eat loop with ground item pickup",
      "description": "As a developer, I want an end-to-end test proving NPCs can cook food, have it spawn on ground/station, then pick it up and eat it.",
      "acceptanceCriteria": [
        "Test spawns NPC, raw_food in container, cooking stations",
        "NPC completes cook_simple_meal job (produces cooked_meal)",
        "cooked_meal spawns at stove output slot or ground",
        "NPC discovers cooked_meal via new discovery system",
        "NPC completes eat_snack job using the cooked_meal",
        "NPC hunger increases after eating",
        "No manual item movement required (unlike current e2e test)"
      ],
      "testCriteria": [
        "test_e2e_cook_eat_autonomous: Full loop without manual item placement",
        "test_e2e_ground_spawn_pickup: Item spawned on ground is found and used",
        "test_e2e_station_output_pickup: Item in station output is found and used",
        "test_e2e_multiple_npcs_no_conflict: Two NPCs don't claim same ground item"
      ],
      "priority": 10,
      "passes": false,
      "notes": "This is the key validation. Current test_production_consumption_loop manually moves items - this should work automatically."
    }
  ]
}
