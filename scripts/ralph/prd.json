{
  "project": "SimGodot",
  "branchName": "ralph/unified-job-completion",
  "description": "Unify job completion pipeline - delegate all completion logic to JobBoard.complete_job(), spawn recipe outputs. Tool handling deferred to future work.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Ensure JobBoard._spawn_outputs places items correctly",
      "description": "As a developer, I want _spawn_outputs to reliably place output items at station output slots or on the ground near the station.",
      "acceptanceCriteria": [
        "_spawn_outputs checks station.place_output_item() for each output",
        "If station has no output slots or they're full, item is placed at station.global_position",
        "Output items are added to the level node scene tree",
        "Item state is set based on tag (e.g., 'cooked' in tag sets COOKED state)",
        "Existing tests in test_jobboard.gd still pass"
      ],
      "testCriteria": [
        "test_spawn_outputs_places_in_output_slot: Item placed in station output slot when available",
        "test_spawn_outputs_fallback_to_ground: Item placed at station.global_position when no slots available",
        "test_spawn_outputs_sets_cooked_state: Item with 'cooked' in tag has COOKED state",
        "test_spawn_outputs_sets_prepped_state: Item with 'prepped' in tag has PREPPED state",
        "test_spawn_outputs_multiple_outputs: Multiple outputs spawn correct quantities"
      ],
      "priority": 1,
      "passes": true,
      "notes": "This is in scripts/job_board.gd around line 315. Check that items are properly instantiated and added to scene."
    },
    {
      "id": "US-002",
      "title": "Refactor NPC._finish_job to delegate to JobBoard.complete_job",
      "description": "As a developer, I want _finish_job to delegate all completion logic to JobBoard so there is one authoritative completion pipeline.",
      "acceptanceCriteria": [
        "_finish_job gets JobBoard reference via get_node('/root/JobBoard')",
        "_finish_job calls job_board.complete_job(current_job, self, target_station)",
        "_finish_job no longer applies motive effects directly (remove the motive_effects loop)",
        "_finish_job no longer handles item consumption (remove queue_free calls on items)",
        "_finish_job still clears held_items array after complete_job returns",
        "_finish_job still releases station reservation",
        "_finish_job still sets current_job = null and current_state = State.IDLE",
        "Existing tests still pass"
      ],
      "testCriteria": [
        "test_finish_job_delegates_to_jobboard: _finish_job calls JobBoard.complete_job()",
        "test_finish_job_clears_held_items: held_items array is empty after _finish_job",
        "test_finish_job_releases_station: target_station.reserved_by is null after _finish_job",
        "test_finish_job_clears_current_job: current_job is null after _finish_job",
        "test_finish_job_sets_idle_state: current_state is State.IDLE after _finish_job",
        "test_finish_job_motive_applied_via_jobboard: Motive effects applied through JobBoard, not NPC"
      ],
      "priority": 2,
      "passes": true,
      "notes": "This is in scripts/npc.gd around line 1289. Remove the duplicated logic but keep local state cleanup."
    },
    {
      "id": "US-003",
      "title": "Remove motive_effects from cook_simple_meal recipe",
      "description": "As a content author, I want the cooking recipe to NOT satisfy hunger directly so that only eating satisfies hunger.",
      "acceptanceCriteria": [
        "resources/recipes/cook_simple_meal.tres has motive_effects = {}",
        "The outputs array still contains cooked_meal",
        "Recipe still has all steps defined"
      ],
      "testCriteria": [
        "test_cook_simple_meal_no_motive_effects: recipe.motive_effects.is_empty() returns true",
        "test_cook_simple_meal_has_output: recipe.get_outputs() contains cooked_meal",
        "test_cook_simple_meal_has_steps: recipe.steps.size() > 0",
        "test_cooking_does_not_satisfy_hunger: NPC hunger unchanged after completing cook job"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Simple resource file edit. The motive satisfaction moves to the consumption recipe."
    },
    {
      "id": "US-004",
      "title": "Remove tools requirement from watch_tv recipe",
      "description": "As a developer, I want to remove the remote tool requirement from watch_tv since tool handling is deferred to future work.",
      "acceptanceCriteria": [
        "resources/recipes/watch_tv.tres has tools = []",
        "Recipe still has all steps defined",
        "Recipe still has motive_effects for fun"
      ],
      "testCriteria": [
        "test_watch_tv_no_tools: recipe.tools.is_empty() returns true",
        "test_watch_tv_has_steps: recipe.steps.size() > 0",
        "test_watch_tv_has_fun_motive: recipe.motive_effects.has('fun') returns true",
        "test_watch_tv_can_start_without_tools: can_start_job succeeds without tool items"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Tool handling is a bigger subject - defer to future PRD. For now, remove the requirement so watch_tv works without tools."
    },
    {
      "id": "US-005",
      "title": "Create eat_snack consumption recipe",
      "description": "As a developer, I want a consumption recipe that demonstrates eating satisfies hunger by consuming a cooked_meal.",
      "acceptanceCriteria": [
        "New file resources/recipes/eat_snack.tres exists",
        "Recipe has inputs = [{'item_tag': 'cooked_meal', 'quantity': 1, 'consumed': true}]",
        "Recipe has steps = [] (no station required, instant consumption)",
        "Recipe has outputs = [] (nothing produced)",
        "Recipe has motive_effects = {'hunger': 50.0}",
        "Recipe has recipe_name = 'Eat Snack'"
      ],
      "testCriteria": [
        "test_eat_snack_exists: RecipeRegistry.get_recipe('eat_snack') returns valid recipe",
        "test_eat_snack_requires_cooked_meal: recipe.get_inputs()[0].item_tag == 'cooked_meal'",
        "test_eat_snack_consumes_input: recipe.get_inputs()[0].consumed == true",
        "test_eat_snack_no_steps: recipe.steps.is_empty() returns true",
        "test_eat_snack_no_outputs: recipe.get_outputs().is_empty() returns true",
        "test_eat_snack_satisfies_hunger: recipe.motive_effects['hunger'] == 50.0",
        "test_eating_consumes_meal_and_satisfies_hunger: Integration test - meal consumed, hunger increased"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Model after existing recipes like use_toilet.tres. This recipe needs no steps since eating can happen anywhere."
    }
  ]
}
