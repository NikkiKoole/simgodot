## Codebase Patterns
- Tests are in scenes/tests/*.tscn (scenes) and scripts/tests/*.gd (code)
- Run tests with: "/Users/nikkikoole/Downloads/Godot 3.app/Contents/MacOS/Godot" --headless scenes/tests/test_*.tscn
- Or run all tests: ./run_tests.sh
- ItemEntity states: RAW, PREPPED, COOKED, DIRTY, BROKEN
- ItemEntity locations: IN_CONTAINER, IN_HAND, IN_SLOT, ON_GROUND
- Station.place_output_item() adds items as children of station
- Items falling back to ground use station.global_position for placement
- JobBoard autoload is at /root/JobBoard (NOT /root/Main/JobBoard)
- When creating test JobBoards, use free() not queue_free() to avoid stale node conflicts
- Level.all_items tracks all spawned items in the level
- Item reservation: item.reserve_item(agent) / item.release_item() / item.is_reserved()

## Key Files for Ground Item Feature
- scripts/level.gd: Has all_items array and get_ground_items_by_tag() (US-001 complete)
- scripts/station.gd: Has output_slots and get_available_output_items_by_tag() (US-002 complete)
- scripts/job_board.gd: can_start_job() and _reserve_items_for_job() check all sources (US-003, US-004 complete)
- scripts/npc.gd: _find_item_source() finds items from containers, stations, ground (US-005 complete)
- scripts/item_entity.gd: Already has location enum and reservation - no changes needed

---

## 2026-01-10 - US-001
- What was implemented: Added Level.get_ground_items_by_tag(tag: String) -> Array[ItemEntity] method
- Files changed:
  - scripts/level.gd: Added get_ground_items_by_tag() method
  - scripts/tests/test_ground_items.gd: New test file with 7 test cases (22 assertions)
  - scenes/tests/test_ground_items.tscn: New test scene
  - run_tests.sh: Added test_ground_items to test suite
- **Learnings for future iterations:**
  - GDScript type inference with `:=` fails when the source method is on a dynamically-typed variable (e.g., `level: Node2D`). Use explicit type annotations like `var result: Array[ItemEntity] = level.method()` instead.
  - Level.add_item() returns ItemEntity and automatically sets location to ON_GROUND and adds to all_items array.
  - Test scenes for Level use TestLevel node (empty level with world_map="" and auto_spawn_npcs=false) as parent, with TestRunner as child.
---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added Station.get_available_output_items_by_tag(tag: String) -> Array[ItemEntity] method
- Files changed:
  - scripts/station.gd: Added get_available_output_items_by_tag() method (8 lines)
  - scripts/tests/test_station.gd: Added 5 test cases for US-002 (18 assertions), also fixed missing `await` on async test calls
- **Learnings for future iterations:**
  - Test functions containing `await` must be called with `await` in run_tests() or execution will skip them
  - Station.output_slot_items is a Dictionary mapping slot_index -> ItemEntity
  - Simple query methods can iterate output_slot_items.values() directly
---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Extended JobBoard.can_start_job() to check ground items and station output slots
- Files changed:
  - scripts/job_board.gd: Modified can_start_job() to accept optional level parameter, check station outputs and ground items for both inputs and tools
  - scripts/tests/test_jobboard.gd: Added 6 new test cases (MockLevel class, tests for ground items, station outputs, combined sources, reserved items, partial sources, backward compatibility)
- **Learnings for future iterations:**
  - can_start_job() now has optional 4th parameter `level: Node = null` for backward compatibility
  - If level is null, tries to get it via `get_tree().current_scene`
  - Use `has_method("get_ground_items_by_tag")` to check if level supports ground item queries
  - Order of item discovery: containers first, then station outputs, then ground items
  - Tools are also searched in station outputs and ground items (not just containers)
---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Extended JobBoard._reserve_items_for_job() and claim_job() to reserve items from all sources (containers, station outputs, ground items)
- Files changed:
  - scripts/job_board.gd: Modified _reserve_items_for_job() to accept optional stations and level parameters, reserve from all sources with priority order (containers > stations > ground). Updated claim_job() to pass new parameters.
  - scripts/tests/test_jobboard.gd: Added 6 new test cases for US-004 (38 assertions): test_reserve_from_container, test_reserve_from_ground, test_reserve_from_station_output, test_reserve_prefers_container, test_reserve_multiple_sources, test_reserve_prevents_double_claim
- **Learnings for future iterations:**
  - claim_job() now accepts optional 4th and 5th parameters: `stations: Array = []` and `level: Node = null`
  - _reserve_items_for_job() uses same priority order as can_start_job(): containers first, then station outputs, then ground items
  - GDScript type inference with `:=` fails when calling methods with multiple optional parameters - use explicit `var claimed: bool = board.claim_job(...)` instead
  - Reservation prevents double-claiming: item.reserve_item(agent) returns false if already reserved by another agent
---

## 2026-01-10 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Added NPC._find_item_source(tag: String) -> Dictionary method to locate items from any source
- Files changed:
  - scripts/npc.gd: Added _find_item_source() method (returns {type, source} dict) and _get_level() helper method
  - scripts/tests/test_find_item_source.gd: New test file with 7 test cases (14 assertions)
  - scenes/tests/test_find_item_source.tscn: New test scene
  - run_tests.sh: Added test_find_item_source to test suite
- **Learnings for future iterations:**
  - _find_item_source() returns Dictionary with 'type' (string) and 'source' (node/null) keys
  - type values: 'container', 'station_output', 'ground', 'none'
  - source is: ItemContainer, Station, ItemEntity (for ground), or null
  - Priority order matches JobBoard: containers first, then station outputs, then ground items
  - Method respects reservations: finds unreserved items OR items reserved by self (when current_job != null)
  - When passing empty typed arrays in tests, use explicit type: `var empty: Array[ItemContainer] = []` not just `[]`
  - _get_level() helper tries current_scene first, then parent node - allows flexibility in test setup
---

## 2026-01-10 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Extended NPC hauling to pick up ground items
- Files changed:
  - scripts/npc.gd: Added target_ground_item state variable, modified _start_gathering_next_item() to use _find_item_source(), added _pathfind_to_ground_item(), _on_arrived_at_ground_item(), _pick_up_ground_item() methods, updated _follow_path_hauling() to handle ground item arrival, updated _cancel_hauling() to clear target_ground_item
  - scripts/tests/test_ground_item_hauling.gd: New test file with 6 test cases (16 assertions)
  - scenes/tests/test_ground_item_hauling.tscn: New test scene
  - run_tests.sh: Added test_ground_item_hauling to test suite
- **Learnings for future iterations:**
  - NPC hauling now uses _find_item_source() to find items from any source (container, station_output, ground)
  - target_ground_item tracks ground items being pathfound to (parallel to target_container)
  - _pick_up_ground_item() removes item from Level.all_items, sets location to IN_HAND, reparents to NPC
  - When ground item disappears before arrival, NPC re-searches for alternatives via _start_gathering_next_item()
  - GDScript typed arrays (Array[Dictionary]) cannot be assigned from untyped array literals - use .clear() and .append() instead
  - Station output pickup is stubbed (TODO for US-007) - _find_item_source returns station but _start_gathering_next_item doesn't handle it yet
---

## 2026-01-10 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Extended NPC hauling to pick up items from station output slots
- Files changed:
  - scripts/npc.gd: Added target_station_output state variable, updated _start_gathering_next_item() to handle station_output source type, added _pathfind_to_station_output(), _on_arrived_at_station_output(), _pick_up_station_output() methods, updated _follow_path_hauling() to handle station output arrival, updated _cancel_hauling() to clear target_station_output
  - scripts/tests/test_station_output_hauling.gd: New test file with 5 test cases (14 assertions)
  - scenes/tests/test_station_output_hauling.tscn: New test scene
  - run_tests.sh: Added test_station_output_hauling to test suite
- **Learnings for future iterations:**
  - NPC hauling now fully supports all three source types: container, ground, and station_output
  - target_station_output tracks stations with output items being pathfound to (parallel to target_container and target_ground_item)
  - _pick_up_station_output() finds the item's slot index and calls station.remove_output_item(slot_index)
  - Station uses get_agent_position() for where NPC should stand when picking up items
  - When station output item disappears before arrival, NPC re-searches for alternatives via _start_gathering_next_item()
  - Pattern: _follow_path_hauling checks targets in order: target_ground_item, target_station_output, then falls back to target_container
---

## 2026-01-10 - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Modified JobBoard._spawn_outputs() to register ground items with Level.all_items
- Files changed:
  - scripts/job_board.gd: Modified _spawn_outputs() to find Level via tree traversal (or fallback to current_scene), register ground items in Level.all_items when no output slot is available
  - scripts/tests/test_jobboard.gd: Added 3 new test cases for US-008 (14 assertions): test_spawn_outputs_registers_ground_items_with_level, test_spawn_outputs_ground_discoverable, test_spawn_outputs_station_slot_not_in_level
- **Learnings for future iterations:**
  - _spawn_outputs() finds Level by traversing up the tree from station, looking for a node with get_ground_items_by_tag() method
  - Fallback to get_tree().current_scene if not found via tree traversal
  - Use `"all_items" in level` to check for property existence (not has_method)
  - Items placed in station output slots do NOT get registered with Level.all_items (they're found via Station.get_available_output_items_by_tag)
  - Only ground items (when output slot is full) get registered with Level.all_items
  - Tests use real Level (LevelScene.instantiate()) instead of mocks for more accurate testing
---

## 2026-01-10 - US-009
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Verified backward compatibility of existing tests with new item discovery system
- Files changed: None - all existing tests already pass
- **Verification:**
  - All 20 test suites pass (1385 total assertions)
  - test_jobboard.gd: 247 assertions pass (includes container workflow tests)
  - test_agent_hauling.gd: 35 assertions pass (container-based hauling)
  - `test_can_start_container_items_unchanged` explicitly tests backward compat for can_start_job
  - `test_reserve_from_container` tests container reservation still works
  - can_start_job() signature is backward compatible (level parameter is optional)
  - claim_job() signature is backward compatible (stations and level parameters are optional)
- **Learnings for future iterations:**
  - When adding optional parameters to existing methods, always add them at the end with default values
  - Existing tests serve as regression tests - no need to duplicate coverage with new test names
  - The test criteria in PRD suggested specific test names but existing tests already covered the same functionality
---
