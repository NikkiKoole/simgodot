## 2026-01-09 - US-017
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Created watch_tv.tres Recipe resource for full TV watching sequence
- Created step_tv_turn_on.tres RecipeStep: tv/turn_on/1s with no transforms
- Created step_tv_watch.tres RecipeStep: couch/watch/10s with no transforms
- Created step_tv_turn_off.tres RecipeStep: tv/turn_off/1s with no transforms
- Recipe inputs: none
- Recipe tools: remote (not consumed)
- Recipe outputs: none
- Recipe motive effects: {fun: 40}
- Created comprehensive test_recipe_tv.gd with 12 test functions and 63 assertions:
  - test_recipe_loads_correctly: Verifies recipe loads from .tres file
  - test_recipe_has_no_inputs: Verifies no inputs required
  - test_recipe_has_correct_tools: Verifies remote tool required
  - test_recipe_has_correct_steps: Verifies 3 steps (tv/turn_on/1s, couch/watch/10s, tv/turn_off/1s)
  - test_recipe_has_no_outputs: Verifies no outputs
  - test_recipe_has_correct_motive_effects: Verifies fun: 40 effect
  - test_step_details: Verifies step animations and no transforms
  - test_full_tv_sequence_setup: Verifies job can be created with recipe
  - test_turn_on_step_at_tv: Verifies turn_on step at tv station
  - test_watch_step_at_couch: Verifies watch step at couch station
  - test_turn_off_step_at_tv: Verifies turn_off step at tv station
  - test_agent_can_execute_full_sequence: Verifies full sequence with motive effects
- Added test_recipe_tv to run_tests.sh
- All tests pass: 627 assertions across 10 test suites
- Files changed:
  - resources/recipes/watch_tv.tres (new)
  - resources/recipes/step_tv_turn_on.tres (new)
  - resources/recipes/step_tv_watch.tres (new)
  - resources/recipes/step_tv_turn_off.tres (new)
  - scripts/tests/test_recipe_tv.gd (new)
  - scenes/tests/test_recipe_tv.tscn (new)
  - run_tests.sh (added test_recipe_tv)
- **Learnings for future iterations:**
  - Recipes can have tools without inputs (TV watching uses remote but consumes nothing)
  - Tools are not consumed - they remain after recipe completion
  - Multi-station sequences with return work (tv -> couch -> tv)
  - PRD says "entertainment" but codebase uses "fun" as the motive name (MotiveType.FUN)
  - The _motive_name_to_type() functions accept both "fun" and "entertainment" as aliases
---

## 2026-01-09 - US-016
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Created use_toilet.tres Recipe resource for full toilet sequence
- Created step_toilet_sit.tres RecipeStep: toilet/sit/5s with no transforms
- Created step_toilet_wash_hands.tres RecipeStep: sink/wash_hands/2s with no transforms
- Recipe inputs: 1x toilet_paper (consumed)
- Recipe outputs: none
- Recipe motive effects: {bladder: 80}
- Created comprehensive test_recipe_toilet.gd with 10 test functions and 45 assertions:
  - test_recipe_loads_correctly: Verifies recipe loads from .tres file
  - test_recipe_has_correct_inputs: Verifies 1x toilet_paper consumed
  - test_recipe_has_correct_steps: Verifies 2 steps (toilet/sit/5s, sink/wash_hands/2s)
  - test_recipe_has_no_outputs: Verifies no outputs
  - test_recipe_has_correct_motive_effects: Verifies bladder: 80 effect
  - test_step_details: Verifies step animations and no transforms
  - test_full_toilet_sequence_setup: Verifies job can be created with recipe
  - test_sit_step_at_toilet: Verifies sit step at toilet station
  - test_wash_hands_step_at_sink: Verifies wash step at sink station
  - test_agent_can_execute_full_sequence: Verifies full sequence with motive effects
- Added test_recipe_toilet to run_tests.sh
- All tests pass: 564 assertions across 9 test suites
- Files changed:
  - resources/recipes/use_toilet.tres (new)
  - resources/recipes/step_toilet_sit.tres (new)
  - resources/recipes/step_toilet_wash_hands.tres (new)
  - scripts/tests/test_recipe_toilet.gd (new)
  - scenes/tests/test_recipe_toilet.tscn (new)
  - run_tests.sh (added test_recipe_toilet)
- **Learnings for future iterations:**
  - Recipes can have no outputs (toilet use doesn't produce items)
  - Recipes can have steps with no input_transform (sit, wash_hands just wait)
  - Bladder motive works like hunger - use Motive.fulfill() to add value
  - Multi-station sequences work (toilet -> sink)
---

## 2026-01-09 - US-015
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Created cook_simple_meal.tres Recipe resource for full cooking sequence
- Created step_prep.tres RecipeStep: counter/prep/3s with raw_food -> prepped_food transform
- Created step_cook.tres RecipeStep: stove/cook/5s with prepped_food -> cooked_meal transform
- Recipe inputs: 1x raw_food (consumed)
- Recipe outputs: 1x cooked_meal
- Recipe motive effects: {hunger: 50}
- Created comprehensive test_recipe_cook.gd with 10 test functions and 42 assertions:
  - test_recipe_loads_correctly: Verifies recipe loads from .tres file
  - test_recipe_has_correct_inputs: Verifies 1x raw_food consumed
  - test_recipe_has_correct_steps: Verifies 2 steps (counter/prep/3s, stove/cook/5s)
  - test_recipe_has_correct_outputs: Verifies 1x cooked_meal output
  - test_recipe_has_correct_motive_effects: Verifies hunger: 50 effect
  - test_step_transforms: Verifies raw_food -> prepped_food -> cooked_meal chain
  - test_full_cooking_sequence_setup: Verifies job can be created with recipe
  - test_prep_step_transforms_raw_to_prepped: Verifies prep step transforms item
  - test_cook_step_transforms_prepped_to_cooked: Verifies cook step transforms item
  - test_agent_can_execute_full_sequence: Verifies full sequence with motive effects
- Added test_recipe_cook to run_tests.sh
- All tests pass: 519 assertions across 8 test suites
- Files changed:
  - resources/recipes/cook_simple_meal.tres (new)
  - resources/recipes/step_prep.tres (new)
  - resources/recipes/step_cook.tres (new)
  - scripts/tests/test_recipe_cook.gd (new)
  - scenes/tests/test_recipe_cook.tscn (new)
  - run_tests.sh (added test_need_jobs and test_recipe_cook)
- **Learnings for future iterations:**
  - Recipe steps reference RecipeStep resources via ExtResource in .tres files
  - Use Motive.fulfill() to add motive value (not add_value)
  - Item transforms chain through steps: raw_food -> prepped_food -> cooked_meal
  - ItemState automatically updates based on tag patterns (cooked_, prepped_)
---

## 2026-01-09 - US-014
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Created RecipeRegistry singleton for storing and querying available recipes
- Added RecipeRegistry as autoload in project.godot
- Implemented get_recipes_for_motive(), get_best_recipe_for_motive(), has_recipe_for_motive()
- Updated NPC._try_start_job_for_needs() to automatically post jobs when no suitable job exists
- Added _try_post_job_for_motive() to find best executable recipe and post job
- Added _calculate_job_priority_for_motive() to set priority based on motive urgency
- Priority formula: priority = (100 - motive_value) / 2 (range 0-100)
- Selects best recipe that can actually be executed (has required items/stations)
- Added 9 comprehensive test functions with 39 passing assertions:
  - test_recipe_registry_creation: Verifies registry creation
  - test_register_recipe: Verifies recipe registration and deduplication
  - test_get_recipes_for_motive: Verifies motive-based recipe queries
  - test_get_best_recipe_for_motive: Verifies highest-effect recipe selection
  - test_has_recipe_for_motive: Verifies motive recipe existence checks
  - test_automatic_job_posting_when_need_critical: Verifies auto-posting when need critical
  - test_job_priority_based_on_urgency: Verifies priority calculation at different motive levels
  - test_no_duplicate_jobs_posted: Verifies existing jobs are found before posting new ones
  - test_best_executable_recipe_selected: Verifies best executable recipe is chosen
- All tests pass: 39 assertions in test_need_jobs
- Files changed:
  - scripts/recipe_registry.gd (new)
  - scripts/npc.gd (added automatic job posting methods)
  - scripts/tests/test_need_jobs.gd (new)
  - scenes/tests/test_need_jobs.tscn (new)
  - project.godot (added RecipeRegistry autoload)
- **Learnings for future iterations:**
  - RecipeRegistry is an autoload singleton like JobBoard
  - Job priority formula: (100 - motive_value) / 2, giving -100 motive = 100 priority
  - When posting jobs for needs, check if recipe can actually be executed first
  - Use JobBoard.can_start_job() with temp job to validate recipe requirements
  - NPC should check for existing available jobs before posting new ones
---

## 2026-01-09 - US-013
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented complete_job(job, agent, station) method in JobBoard
- Added _spawn_outputs() to create output items at station output slots
- Added _apply_motive_effects() to apply recipe motive effects to agent
- Added _handle_item_consumption() to consume inputs and preserve tools
- Added _get_original_tag() to trace transformed items back to original input tags
- Added _motive_name_to_type() using Motive.MotiveType enum directly
- Output items automatically get appropriate ItemState based on tag (cooked, prepped)
- Added MockAgent inner class in tests for proper motives property testing
- Added 7 comprehensive test functions with 19 new assertions:
  - test_complete_job_basic: Verifies complete only works on IN_PROGRESS jobs
  - test_complete_job_motive_effects: Verifies motive effects applied to agent
  - test_complete_job_spawns_outputs: Verifies outputs spawned at station slots
  - test_complete_job_consumes_inputs: Verifies consumed inputs are queue_free'd
  - test_complete_job_preserves_tools: Verifies tools remain after completion
  - test_complete_job_with_transforms: Verifies transformed items traced to original
  - test_complete_job_invalid_states: Verifies error handling for invalid inputs
- All tests pass: 414 assertions across all test suites (160 in test_jobboard)
- Files changed:
  - scripts/job_board.gd (added complete_job and helper methods)
  - scripts/tests/test_jobboard.gd (added 7 completion tests, MockAgent class)
- **Learnings for future iterations:**
  - Use Motive.MotiveType enum directly instead of hardcoded integers for motive types
  - Agent.get("motives") returns null for Node2D - need inner class with motives property
  - Transformed items should be traced back to original tag to determine if consumed
  - Output item state can be derived from tag patterns (cooked_, prepped_)
  - complete_job() only works on IN_PROGRESS jobs (same pattern as interrupt_job)
---

## 2026-01-09 - US-012
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added job_interrupted signal to JobBoard
- Implemented interrupt_job(job) method in JobBoard - only interrupts IN_PROGRESS jobs
- Added interrupt_current_job() method to NPC for agent-side interruption handling
- Added _drop_item_on_interrupt() helper to drop held items ON_GROUND during interruption
- Items already in station slots remain IN_SLOT (preserved for resumption)
- Updated start_hauling_for_job() to handle resumed interrupted jobs
- Added _account_for_existing_items() to check station slots for items from interrupted job
- Added _reduce_gather_requirement() to reduce gathering requirements when items already exist
- Added 6 comprehensive test functions with 34 new assertions:
  - test_interrupt_job: Verifies interrupt only works on IN_PROGRESS jobs
  - test_interrupt_job_signal: Verifies job_interrupted signal emission
  - test_interrupt_job_preserves_step_index: Verifies current_step_index preserved
  - test_interrupted_job_claimable: Verifies INTERRUPTED jobs appear in available jobs
  - test_interrupted_job_reservations_released: Verifies item/station reservations released
  - test_resume_interrupted_job: Verifies agent can resume from preserved step index
- All tests pass: 141 assertions in test_jobboard
- Files changed:
  - scripts/job_board.gd (added job_interrupted signal, interrupt_job method)
  - scripts/npc.gd (added interrupt_current_job, _drop_item_on_interrupt, resume support)
  - scripts/tests/test_jobboard.gd (added 6 interruption tests)
- **Learnings for future iterations:**
  - JobBoard.interrupt_job() only works on IN_PROGRESS jobs (not POSTED, CLAIMED, etc.)
  - Job.interrupt() already handles releasing item reservations via gathered_items array
  - When resuming interrupted job, check job.current_step_index > 0 to detect resumed jobs
  - Items in station slots survive interruption and can be used by resuming agent
  - Use explicit type annotations (e.g., `var interrupted: bool = ...`) for GDScript type inference
---

## Codebase Patterns
- This is a Godot 4.5 project using GDScript
- When iterating over an array and modifying it, make a duplicate first to avoid skipping items
- Use `class_name` at top of scripts for global class registration (but NOT for autoload singletons)
- Autoload singletons: Do NOT use `class_name` - causes "hides an autoload singleton" error
- Lambda variable capture: GDScript lambdas capture by value, not reference. Use Dictionary for mutable state tracking in test signal handlers
- Use type hints throughout (e.g., `var name: String = ""`)
- Use `@export` for inspector-visible properties
- Enums defined within classes using `enum EnumName { VALUE1, VALUE2 }`
- Signals declared with typed parameters (e.g., `signal value_changed(new_value: float)`)
- ColorRect named "Sprite2D" used for visual representation in scenes
- Run Godot validation: `"/Users/nikkikoole/Downloads/Godot 3.app/Contents/MacOS/Godot" --headless --import --quit` (use --import to catch script errors)

- ItemContainer class (renamed from Container to avoid Godot reserved name conflict) uses typed arrays: `Array[ItemEntity]` and `Array[String]`
- Avoid Godot reserved class names: Container, Node, Control, etc. - use prefixes like ItemContainer
- Station uses Marker2D children for slots/footprint - auto-discovered by name prefix (InputSlot*, OutputSlot*, AgentFootprint)
- Slot items tracked via Dictionary mapping slot_index to ItemEntity
- Resources (extending Resource) use class_name for global registration and are saved as .tres files
- Resources directory: resources/recipes/ for recipe-related resources
- Inner classes in GDScript use `class ClassName:` syntax within the main script
- For Resource serialization, complex inner class data is stored as Array[Dictionary] with to_dict()/from_dict() conversion
- Job class extends RefCounted (not Node2D or Resource) for lightweight state tracking objects
- Use static var for ID counters in classes that need unique IDs (e.g., `static var _next_id: int = 0`)
- Test runner auto-quits in headless mode with exit code 0 (pass) or 1 (fail)
- JobBoard.claim_job() accepts optional containers array to auto-reserve items
- Job.release(), Job.complete(), Job.fail(), and Job.interrupt() all unreserve gathered items
- **Motive-driven jobs use Sims-style "world task" architecture**: Jobs represent shared work (cooking a meal), not personal quests. Multiple hungry NPCs each post their own jobs. INTERRUPTED jobs can be claimed by other NPCs (food shouldn't waste). Single-threaded execution makes postâ†’claim atomic.

---

## 2026-01-09 - US-011
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added WORKING state (value 5) to NPC state machine enum
- Added working state variables: available_stations, target_station, work_timer, current_animation
- Implemented set_available_stations() for level to provide station references
- Implemented _start_next_work_step() to find station for current recipe step and pathfind to it
- Implemented _find_station_for_step() to locate available stations matching step's station_tag
- Implemented _pathfind_to_station() to navigate to station's agent_footprint position
- Implemented _follow_path_working() for movement in WORKING state (with stuck detection)
- Implemented _on_arrived_at_station() to place items and start work timer
- Implemented _place_items_in_station() to put held items into station input slots
- Implemented _start_step_work() to set work_timer from step.duration and start animation
- Implemented _do_work() main loop that handles pathfinding then work timer countdown
- Implemented _on_step_complete() to apply transforms, advance steps, or finish job
- Implemented _apply_step_transforms() to change item tags based on step.input_transform
- Implemented _pick_up_items_from_station() to retrieve items from slots
- Implemented _finish_job() to apply motive effects, consume items, and complete job
- Implemented _cancel_working() to release resources on failure
- Implemented _play_animation() and _stop_animation() stubs for AnimationPlayer support
- Implemented _motive_name_to_type() to convert string motive names to MotiveType enum
- Implemented get_work_progress() and is_working() helper methods
- Updated _on_all_items_gathered() to transition from HAULING to WORKING state
- Created test_agent_working.gd with 12 test functions and 38 passing assertions
- Files changed:
  - scripts/npc.gd (added WORKING state, ~300 lines of working state logic)
  - scripts/tests/test_agent_working.gd (new)
  - scenes/tests/test_agent_working.tscn (new)
- **Learnings for future iterations:**
  - WORKING state handles both pathfinding to station AND executing work at station
  - Items are placed in station input slots on arrival, picked up before leaving
  - Step transforms change item.item_tag and also update item.state based on tag patterns
  - Motive effects use string keys in recipe (e.g., "hunger") converted to MotiveType enum
  - Job completion consumes items matching recipe.get_consumed_input_tags()
  - When testing functions that return nullable types, use explicit type annotations (e.g., `var found: Station = ...`)
  - The _do_work() function first checks if still pathfinding, then counts down work timer
---

## 2026-01-09 - US-009
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Extended JobBoard.claim_job() to accept optional containers parameter for auto-reserving items
- Added _reserve_items_for_job() helper method to reserve input items and tools
- Updated Job.release() to unreserve all gathered items before releasing
- Updated Job.complete() to unreserve all gathered items on completion
- Updated Job.fail() to unreserve all gathered items on failure
- Job.interrupt() already unreserved items (from US-006)
- Added 5 new test functions to test_items.gd with 24 new assertions:
  - test_job_claim_reserves_items: Verifies items reserved when job claimed with containers
  - test_job_release_unreserves_items: Verifies items unreserved on job release
  - test_job_complete_unreserves_items: Verifies items unreserved on job completion
  - test_job_fail_unreserves_items: Verifies items unreserved on job failure
  - test_job_interrupt_unreserves_items: Verifies items unreserved on job interruption
- All tests pass: 73 in test_items, 107 in test_jobboard, 93 in test_job
- Files changed:
  - scripts/job_board.gd (added containers param, _reserve_items_for_job method)
  - scripts/job.gd (updated release, complete, fail to unreserve items)
  - scripts/tests/test_items.gd (added job reservation tests)
- **Learnings for future iterations:**
  - claim_job() third parameter (containers) is optional for backward compatibility
  - Items reserved during claim are tracked via job.gathered_items array
  - All job termination states (release, complete, fail, interrupt) must unreserve items
  - Test reservation by checking both item.is_reserved() and container.get_available_count()

---

## 2026-01-09 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented JobBoard singleton extending Node for central job management
- Registered as autoload in project.godot: `JobBoard="*res://scripts/job_board.gd"`
- Added core methods: post_job(), get_available_jobs(), claim_job(), release_job()
- Added motive-based queries: get_jobs_for_motive(), get_available_jobs_for_motive()
- Added priority selection: get_highest_priority_job(), get_highest_priority_job_for_motive()
- Added signals: job_posted, job_claimed, job_completed, job_released, job_failed
- Added helper methods: get_job_by_id(), get_jobs_by_state(), get_jobs_for_agent()
- Added cleanup: remove_job(), cleanup_finished_jobs(), clear_all_jobs()
- Created comprehensive test suite with 73 passing tests
- Updated AGENTS.md with JobBoard documentation and lambda capture gotcha
- Files changed:
  - scripts/job_board.gd (new)
  - scripts/tests/test_jobboard.gd (new)
  - scenes/tests/test_jobboard.tscn (new)
  - project.godot (added autoload)
  - AGENTS.md (updated)
- **Learnings for future iterations:**
  - Autoload singletons must NOT use `class_name` - causes "hides an autoload singleton" error
  - When testing signals with lambdas, use Dictionary to track state (lambdas capture by value, not reference)
  - Autoloads are registered in project.godot under [autoload] section with `*` prefix for Node scripts
  - Test files for autoloads should preload the script and create instances rather than relying on the autoload

---

## 2026-01-09 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented Job class extending RefCounted for tracking work state and progress
- Added JobState enum: POSTED, CLAIMED, IN_PROGRESS, INTERRUPTED, COMPLETED, FAILED
- Added properties: job_id, recipe, priority, claimed_by, current_step_index, gathered_items, target_station
- Implemented claim/release methods with proper state validation
- Implemented start(), interrupt(), complete(), fail() state transition methods
- Added step tracking: advance_step(), get_current_step(), get_remaining_steps(), get_progress()
- Added gathered items management: add_gathered_item(), remove_gathered_item(), clear_gathered_items()
- Interruption releases item and station reservations, preserves step index
- Created comprehensive test suite with 93 passing tests
- Fixed duplicate class_name in recipe_step.gd discovered during testing
- Files changed:
  - scripts/job.gd (new)
  - scripts/tests/test_job.gd (new)
  - scenes/tests/test_job.tscn (new)
  - scripts/recipe_step.gd (fixed duplicate class_name)
- **Learnings for future iterations:**
  - Use RefCounted for lightweight objects that don't need scene tree presence
  - Static variables work for class-level counters in GDScript
  - When allowing re-claim by same agent, check agent identity before state check
  - Never duplicate `class_name` or `extends` lines - causes parse errors
  - Test runner now auto-quits in headless mode (added DisplayServer.get_name() == "headless" check)

---

## 2026-01-09 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented Recipe class extending Resource for complete interaction sequences
- Added recipe_name (String), inputs (Array[Dictionary]), tools (Array[String])
- Added steps (Array[RecipeStep]), outputs (Array[Dictionary]), motive_effects (Dictionary)
- Created RecipeInput inner class with: item_tag, quantity, consumed (with to_dict/from_dict serialization)
- Created RecipeOutput inner class with: item_tag, quantity (with to_dict/from_dict serialization)
- Added helper methods: get_inputs(), get_outputs(), add_input(), add_output(), add_tool(), add_step()
- Added query methods: get_step_count(), get_step(), get_total_duration(), get_required_stations()
- Added motive methods: affects_motive(), get_motive_effect(), get_affected_motives()
- Created example_recipe.tres as example resource file referencing example_step_prep.tres
- Files changed:
  - scripts/recipe.gd (new)
  - resources/recipes/example_recipe.tres (new)
- **Learnings for future iterations:**
  - Inner classes defined with `class ClassName:` inside the script
  - Inner classes cannot be directly serialized by Godot's @export, so use Dictionary conversion
  - Use Array[Dictionary] for @export of inner class data, with from_dict()/to_dict() helper methods
  - Recipe references RecipeStep resources in steps array for multi-step sequences
  - Resources can reference other resources using ExtResource in .tres files

---

## 2026-01-09 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented RecipeStep class extending Resource for defining individual steps in interaction sequences
- Added properties: station_tag (String), action (String), duration (float), animation (String)
- Added input_transform Dictionary for item state transformations (e.g., {"raw_food": "prepped_food"})
- Added helper methods: get_transformed_tag(), transforms_item(), get_transform_inputs(), get_transform_outputs()
- Created example_step_prep.tres as example resource file
- Files changed:
  - scripts/recipe_step.gd (new)
  - resources/recipes/example_step_prep.tres (new)
- **Learnings for future iterations:**
  - Resources extend Resource class, not Node2D
  - Resources are saved as .tres files with [gd_resource] header
  - Use script_class attribute in .tres for typed resources
  - Helper methods make it easier to work with transform dictionaries

---

## 2026-01-09 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented Station class extending Node2D for smart stations (stove, toilet, TV)
- Added station_tag property for identifying station type
- Added input_slots and output_slots as arrays of Marker2D
- Added agent_footprint Marker2D for agent standing position
- Added reserved_by property with reserve(), release(), is_available() methods
- Implemented get_item_in_slot(), place_item_in_slot() methods with input/output variants
- Added auto-discovery of Marker2D children by name prefix (InputSlot*, OutputSlot*, AgentFootprint)
- Created station.tscn scene with blue-gray ColorRect visual (48x48 pixels)
- Files changed:
  - scripts/station.gd (new)
  - scenes/objects/station.tscn (new)
- **Learnings for future iterations:**
  - Station uses Dictionary (input_slot_items, output_slot_items) to track items by slot index
  - Marker2D nodes auto-discovered by name prefix for convenience
  - Items placed in slots are reparented to station and positioned at slot marker
  - get_agent_position() returns global position where agent should stand
  - Convenience methods like get_input_item(), place_output_item() simplify common operations

---

## 2026-01-09 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented ItemContainer class extending Node2D for storing ItemEntity references (renamed from Container to avoid Godot reserved name conflict)
- Added capacity property with has_space() check
- Added allowed_tags array for filtering (empty = allow all)
- Implemented add_item(), remove_item(), find_item_by_tag() methods
- Implemented get_available_items() returning unreserved items
- Added helper methods: get_available_items_by_tag(), has_available_item(), get_available_count()
- Created container.tscn scene with brown ColorRect visual (32x32 pixels)
- Files changed:
  - scripts/container.gd (new)
  - scenes/objects/container.tscn (new)
- **Learnings for future iterations:**
  - ItemContainer reparents items when added (item becomes child of container)
  - Use typed arrays like `Array[ItemEntity]` for type safety
  - ItemContainer uses is_tag_allowed() to validate before adding items
  - get_available_items() filters out reserved items using item.is_reserved()
  - IMPORTANT: "Container" is a reserved Godot class name - use ItemContainer instead

---

## 2026-01-09 - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented can_start_job(job, containers, stations) method in JobBoard
- Created JobRequirementResult inner class with can_start, reason, missing_items, missing_tools, missing_stations
- Validates required items exist in accessible containers (using get_available_count)
- Validates required tools are available in containers (using has_available_item)
- Validates required stations are available (not reserved)
- Returns detailed reason string when requirements not met
- Added 7 comprehensive test functions with 34 new assertions
- Files changed:
  - scripts/job_board.gd (added can_start_job method and JobRequirementResult class)
  - scripts/tests/test_jobboard.gd (added test_can_start_job_* tests)
- **Learnings for future iterations:**
  - Inner classes in autoload singletons work fine (JobRequirementResult inside job_board.gd)
  - can_start_job takes containers and stations as parameters for flexibility
  - ItemContainer.get_available_count() excludes reserved items automatically
  - Station.is_available() checks if reserved_by is null
  - Tests create helper functions (_create_container, _create_item, _create_station, _create_recipe_with_inputs) for cleaner test code
---

## 2026-01-09 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented ItemEntity class extending Node2D with all required properties
- Created ItemState enum (RAW, PREPPED, COOKED, DIRTY, BROKEN)
- Created ItemLocation enum (IN_CONTAINER, IN_HAND, IN_SLOT, ON_GROUND)
- Added reservation system with reserve_item(), release_item(), is_reserved() methods
- Added state/location change methods with signals
- Created item_entity.tscn scene for spawning items
- Files changed:
  - scripts/item_entity.gd (new)
  - scenes/objects/item_entity.tscn (new)
- **Learnings for future iterations:**
  - Godot 4 uses `@export` instead of `export`
  - Scenes use `.tscn` format with `[gd_scene]` header
  - Scene files need `uid://` for unique identification
  - Scripts are attached via `ExtResource` in scene files
  - Project runs from command line with `--headless --quit` flags for validation
---

## 2026-01-09 - US-010
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Added HAULING state to NPC state machine (State.HAULING = 4)
- Added held_items array (Array[ItemEntity]) for tracking items agent is carrying
- Added job system properties: current_job, available_containers, target_container, items_to_gather
- Implemented start_hauling_for_job(job) to initialize hauling for a job's requirements
- Implemented _start_gathering_next_item() to find and pathfind to containers with needed items
- Implemented _follow_path_hauling() for movement in HAULING state (similar to WALKING but handles container arrival)
- Implemented _on_arrived_at_container() to pick up items when reaching container
- Implemented _pick_up_item() to remove from container, set IN_HAND, add to held_items
- Implemented _cancel_hauling() to drop all items and release job on failure
- Implemented _drop_item() to release item back to world
- Implemented helper methods: get_held_items(), is_holding_items(), remove_held_item()
- Added set_available_containers() for level to provide container references
- Created test_agent_hauling.gd with 35 passing assertions
- Files changed:
  - scripts/npc.gd (added HAULING state, held_items, hauling methods)
  - scripts/tests/test_agent_hauling.gd (new)
  - scenes/tests/test_agent_hauling.tscn (new)
- **Learnings for future iterations:**
  - When iterating over an array and modifying it (like dropping items), make a duplicate first
  - NPC hauling uses items_to_gather array of {tag, quantity} dictionaries to track requirements
  - _pick_up_item handles container removal, item state change, and reparenting to agent
  - After gathering all items, _on_all_items_gathered() is called (transitions to station in US-011)
  - Use typed arrays (Array[ItemEntity]) for held_items to maintain type safety
---
