## Codebase Patterns
- This is a Godot 4.5 project using GDScript
- Use `class_name` at top of scripts for global class registration (but NOT for autoload singletons)
- Autoload singletons: Do NOT use `class_name` - causes "hides an autoload singleton" error
- Lambda variable capture: GDScript lambdas capture by value, not reference. Use Dictionary for mutable state tracking in test signal handlers
- Use type hints throughout (e.g., `var name: String = ""`)
- Use `@export` for inspector-visible properties
- Enums defined within classes using `enum EnumName { VALUE1, VALUE2 }`
- Signals declared with typed parameters (e.g., `signal value_changed(new_value: float)`)
- ColorRect named "Sprite2D" used for visual representation in scenes
- Run Godot validation: `"/Users/nikkikoole/Downloads/Godot 3.app/Contents/MacOS/Godot" --headless --import --quit` (use --import to catch script errors)

- ItemContainer class (renamed from Container to avoid Godot reserved name conflict) uses typed arrays: `Array[ItemEntity]` and `Array[String]`
- Avoid Godot reserved class names: Container, Node, Control, etc. - use prefixes like ItemContainer
- Station uses Marker2D children for slots/footprint - auto-discovered by name prefix (InputSlot*, OutputSlot*, AgentFootprint)
- Slot items tracked via Dictionary mapping slot_index to ItemEntity
- Resources (extending Resource) use class_name for global registration and are saved as .tres files
- Resources directory: resources/recipes/ for recipe-related resources
- Inner classes in GDScript use `class ClassName:` syntax within the main script
- For Resource serialization, complex inner class data is stored as Array[Dictionary] with to_dict()/from_dict() conversion
- Job class extends RefCounted (not Node2D or Resource) for lightweight state tracking objects
- Use static var for ID counters in classes that need unique IDs (e.g., `static var _next_id: int = 0`)
- Test runner auto-quits in headless mode with exit code 0 (pass) or 1 (fail)

---

## 2026-01-09 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented JobBoard singleton extending Node for central job management
- Registered as autoload in project.godot: `JobBoard="*res://scripts/job_board.gd"`
- Added core methods: post_job(), get_available_jobs(), claim_job(), release_job()
- Added motive-based queries: get_jobs_for_motive(), get_available_jobs_for_motive()
- Added priority selection: get_highest_priority_job(), get_highest_priority_job_for_motive()
- Added signals: job_posted, job_claimed, job_completed, job_released, job_failed
- Added helper methods: get_job_by_id(), get_jobs_by_state(), get_jobs_for_agent()
- Added cleanup: remove_job(), cleanup_finished_jobs(), clear_all_jobs()
- Created comprehensive test suite with 73 passing tests
- Updated AGENTS.md with JobBoard documentation and lambda capture gotcha
- Files changed:
  - scripts/job_board.gd (new)
  - scripts/tests/test_jobboard.gd (new)
  - scenes/tests/test_jobboard.tscn (new)
  - project.godot (added autoload)
  - AGENTS.md (updated)
- **Learnings for future iterations:**
  - Autoload singletons must NOT use `class_name` - causes "hides an autoload singleton" error
  - When testing signals with lambdas, use Dictionary to track state (lambdas capture by value, not reference)
  - Autoloads are registered in project.godot under [autoload] section with `*` prefix for Node scripts
  - Test files for autoloads should preload the script and create instances rather than relying on the autoload

---

## 2026-01-09 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented Job class extending RefCounted for tracking work state and progress
- Added JobState enum: POSTED, CLAIMED, IN_PROGRESS, INTERRUPTED, COMPLETED, FAILED
- Added properties: job_id, recipe, priority, claimed_by, current_step_index, gathered_items, target_station
- Implemented claim/release methods with proper state validation
- Implemented start(), interrupt(), complete(), fail() state transition methods
- Added step tracking: advance_step(), get_current_step(), get_remaining_steps(), get_progress()
- Added gathered items management: add_gathered_item(), remove_gathered_item(), clear_gathered_items()
- Interruption releases item and station reservations, preserves step index
- Created comprehensive test suite with 93 passing tests
- Fixed duplicate class_name in recipe_step.gd discovered during testing
- Files changed:
  - scripts/job.gd (new)
  - scripts/tests/test_job.gd (new)
  - scenes/tests/test_job.tscn (new)
  - scripts/recipe_step.gd (fixed duplicate class_name)
- **Learnings for future iterations:**
  - Use RefCounted for lightweight objects that don't need scene tree presence
  - Static variables work for class-level counters in GDScript
  - When allowing re-claim by same agent, check agent identity before state check
  - Never duplicate `class_name` or `extends` lines - causes parse errors
  - Test runner now auto-quits in headless mode (added DisplayServer.get_name() == "headless" check)

---

## 2026-01-09 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented Recipe class extending Resource for complete interaction sequences
- Added recipe_name (String), inputs (Array[Dictionary]), tools (Array[String])
- Added steps (Array[RecipeStep]), outputs (Array[Dictionary]), motive_effects (Dictionary)
- Created RecipeInput inner class with: item_tag, quantity, consumed (with to_dict/from_dict serialization)
- Created RecipeOutput inner class with: item_tag, quantity (with to_dict/from_dict serialization)
- Added helper methods: get_inputs(), get_outputs(), add_input(), add_output(), add_tool(), add_step()
- Added query methods: get_step_count(), get_step(), get_total_duration(), get_required_stations()
- Added motive methods: affects_motive(), get_motive_effect(), get_affected_motives()
- Created example_recipe.tres as example resource file referencing example_step_prep.tres
- Files changed:
  - scripts/recipe.gd (new)
  - resources/recipes/example_recipe.tres (new)
- **Learnings for future iterations:**
  - Inner classes defined with `class ClassName:` inside the script
  - Inner classes cannot be directly serialized by Godot's @export, so use Dictionary conversion
  - Use Array[Dictionary] for @export of inner class data, with from_dict()/to_dict() helper methods
  - Recipe references RecipeStep resources in steps array for multi-step sequences
  - Resources can reference other resources using ExtResource in .tres files

---

## 2026-01-09 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented RecipeStep class extending Resource for defining individual steps in interaction sequences
- Added properties: station_tag (String), action (String), duration (float), animation (String)
- Added input_transform Dictionary for item state transformations (e.g., {"raw_food": "prepped_food"})
- Added helper methods: get_transformed_tag(), transforms_item(), get_transform_inputs(), get_transform_outputs()
- Created example_step_prep.tres as example resource file
- Files changed:
  - scripts/recipe_step.gd (new)
  - resources/recipes/example_step_prep.tres (new)
- **Learnings for future iterations:**
  - Resources extend Resource class, not Node2D
  - Resources are saved as .tres files with [gd_resource] header
  - Use script_class attribute in .tres for typed resources
  - Helper methods make it easier to work with transform dictionaries

---

## 2026-01-09 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented Station class extending Node2D for smart stations (stove, toilet, TV)
- Added station_tag property for identifying station type
- Added input_slots and output_slots as arrays of Marker2D
- Added agent_footprint Marker2D for agent standing position
- Added reserved_by property with reserve(), release(), is_available() methods
- Implemented get_item_in_slot(), place_item_in_slot() methods with input/output variants
- Added auto-discovery of Marker2D children by name prefix (InputSlot*, OutputSlot*, AgentFootprint)
- Created station.tscn scene with blue-gray ColorRect visual (48x48 pixels)
- Files changed:
  - scripts/station.gd (new)
  - scenes/objects/station.tscn (new)
- **Learnings for future iterations:**
  - Station uses Dictionary (input_slot_items, output_slot_items) to track items by slot index
  - Marker2D nodes auto-discovered by name prefix for convenience
  - Items placed in slots are reparented to station and positioned at slot marker
  - get_agent_position() returns global position where agent should stand
  - Convenience methods like get_input_item(), place_output_item() simplify common operations

---

## 2026-01-09 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented ItemContainer class extending Node2D for storing ItemEntity references (renamed from Container to avoid Godot reserved name conflict)
- Added capacity property with has_space() check
- Added allowed_tags array for filtering (empty = allow all)
- Implemented add_item(), remove_item(), find_item_by_tag() methods
- Implemented get_available_items() returning unreserved items
- Added helper methods: get_available_items_by_tag(), has_available_item(), get_available_count()
- Created container.tscn scene with brown ColorRect visual (32x32 pixels)
- Files changed:
  - scripts/container.gd (new)
  - scenes/objects/container.tscn (new)
- **Learnings for future iterations:**
  - ItemContainer reparents items when added (item becomes child of container)
  - Use typed arrays like `Array[ItemEntity]` for type safety
  - ItemContainer uses is_tag_allowed() to validate before adding items
  - get_available_items() filters out reserved items using item.is_reserved()
  - IMPORTANT: "Container" is a reserved Godot class name - use ItemContainer instead

---

## 2026-01-09 - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented can_start_job(job, containers, stations) method in JobBoard
- Created JobRequirementResult inner class with can_start, reason, missing_items, missing_tools, missing_stations
- Validates required items exist in accessible containers (using get_available_count)
- Validates required tools are available in containers (using has_available_item)
- Validates required stations are available (not reserved)
- Returns detailed reason string when requirements not met
- Added 7 comprehensive test functions with 34 new assertions
- Files changed:
  - scripts/job_board.gd (added can_start_job method and JobRequirementResult class)
  - scripts/tests/test_jobboard.gd (added test_can_start_job_* tests)
- **Learnings for future iterations:**
  - Inner classes in autoload singletons work fine (JobRequirementResult inside job_board.gd)
  - can_start_job takes containers and stations as parameters for flexibility
  - ItemContainer.get_available_count() excludes reserved items automatically
  - Station.is_available() checks if reserved_by is null
  - Tests create helper functions (_create_container, _create_item, _create_station, _create_recipe_with_inputs) for cleaner test code
---

## 2026-01-09 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented ItemEntity class extending Node2D with all required properties
- Created ItemState enum (RAW, PREPPED, COOKED, DIRTY, BROKEN)
- Created ItemLocation enum (IN_CONTAINER, IN_HAND, IN_SLOT, ON_GROUND)
- Added reservation system with reserve_item(), release_item(), is_reserved() methods
- Added state/location change methods with signals
- Created item_entity.tscn scene for spawning items
- Files changed:
  - scripts/item_entity.gd (new)
  - scenes/objects/item_entity.tscn (new)
- **Learnings for future iterations:**
  - Godot 4 uses `@export` instead of `export`
  - Scenes use `.tscn` format with `[gd_scene]` header
  - Scene files need `uid://` for unique identification
  - Scripts are attached via `ExtResource` in scene files
  - Project runs from command line with `--headless --quit` flags for validation
---
